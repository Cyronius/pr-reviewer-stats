<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PR Velocity Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        .controls-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .controls-row.full-width {
            display: grid;
            grid-template-columns: auto 1fr;
        }
        .controls-row.full-width .control-group {
            flex: 1;
        }
        .control-group {
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .control-group label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn-group {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .btn:hover {
            background: #f0f0f0;
        }
        .btn.active {
            background: #0078d4;
            color: white;
            border-color: #0078d4;
        }
        .contributor-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .chip {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            color: white;
        }
        .chip:hover {
            opacity: 0.85;
        }
        .chip.selected {
            box-shadow: 0 0 0 2px white, 0 0 0 4px var(--chip-color, currentColor);
        }
        .stats-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            flex: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            color: #666;
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
            color: var(--kpi-color, #0078d4);
        }
        .stat-card .subtitle {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .chart-container h2 {
            color: #333;
            font-size: 18px;
        }
        .chart-note {
            font-size: 12px;
            color: #888;
            font-style: italic;
        }
        .chart-wrapper {
            position: relative;
            height: 450px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            text-align: center;
            padding: 40px;
            color: #d32f2f;
            background: #ffebee;
            border-radius: 8px;
        }
        .file-input {
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .file-input label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        .leaderboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .leaderboard-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .leaderboard-card h3 {
            margin-bottom: 15px;
            color: #333;
        }
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        .leaderboard-item:hover {
            background: #f5f5f5;
            margin: 0 -10px;
            padding: 8px 10px;
        }
        .leaderboard-item:last-child {
            border-bottom: none;
        }
        .leaderboard-item .name {
            color: #333;
        }
        .leaderboard-item .count {
            font-weight: bold;
            color: #0078d4;
        }
        .leaderboard-item.selected {
            background: #e3f2fd;
            margin: 0 -10px;
            padding: 8px 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PR Velocity Dashboard</h1>

        <div style="margin-bottom: 20px; padding: 40px;">
            <div class="file-input" style="display: inline-flex;">
                <label for="csvFile">Load Data</label>
                <input type="file" id="csvFile" accept=".csv">
            </div>
        </div>

        <div id="content" class="loading">Loading data...</div>
    </div>

    <script>
        // Color palette for authors
        const colors = [
            '#0078d4', '#00bcf2', '#00b294', '#bad80a', '#ff8c00',
            '#e81123', '#5c2d91', '#0063b1', '#107c10', '#ffb900',
            '#ea4300', '#b4009e', '#00188f', '#68768a', '#004e8c'
        ];

        const teamColor = '#333';

        let chart = null;
        let allRecords = [];
        let processedData = null;
        let selectedAuthor = null; // null means "all/team"
        let selectedRange = 'all';
        let smoothingEnabled = true;

        const ranges = {
            'week': { label: 'Past Week', days: 7, smoothing: 1, smoothingLabel: 'no smoothing' },
            'month': { label: 'Past Month', days: 30, smoothing: 3, smoothingLabel: '3-day moving average' },
            '3months': { label: 'Past 3 Months', days: 90, smoothing: 5, smoothingLabel: '5-day moving average' },
            'year': { label: 'Past Year', days: 365, smoothing: 7, smoothingLabel: '7-day moving average' },
            'all': { label: 'All Time', days: null, smoothing: 30, smoothingLabel: '30-day moving average' }
        };

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const records = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                const values = [];
                let current = '';
                let inQuotes = false;

                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current);

                if (values.length >= 5) {
                    records.push({
                        author: values[0],
                        authorEmail: values[1],
                        project: values[2],
                        repository: values[3],
                        closedDate: values[4],
                        prId: parseInt(values[5]) || 0,
                        title: values[6] || ''
                    });
                }
            }

            return records;
        }

        function filterByRange(records, rangeDays) {
            if (!rangeDays) return records;
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - rangeDays);
            const cutoffStr = cutoff.toISOString().split('T')[0];
            return records.filter(r => r.closedDate >= cutoffStr);
        }

        function processData(records) {
            // Group by day and author
            const byDay = {};
            const byAuthor = {};
            const byProject = {};
            const authors = new Set();

            for (const r of records) {
                const day = r.closedDate; // Already in YYYY-MM-DD format

                authors.add(r.author);

                if (!byDay[day]) byDay[day] = { total: 0 };
                if (!byDay[day][r.author]) byDay[day][r.author] = 0;
                byDay[day][r.author]++;
                byDay[day].total++;

                byAuthor[r.author] = (byAuthor[r.author] || 0) + 1;
                byProject[r.project] = (byProject[r.project] || 0) + 1;
            }

            // Fill in missing days with zeros for continuous data
            const days = Object.keys(byDay).sort();
            if (days.length > 1) {
                const startDate = new Date(days[0]);
                const endDate = new Date(days[days.length - 1]);
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dayStr = d.toISOString().split('T')[0];
                    if (!byDay[dayStr]) {
                        byDay[dayStr] = { total: 0 };
                    }
                }
            }

            const allDays = Object.keys(byDay).sort();
            const authorList = Array.from(authors).sort((a, b) => byAuthor[b] - byAuthor[a]);

            return { byDay, byAuthor, byProject, days: allDays, authorList, totalPRs: records.length };
        }

        function calculateMovingAverage(data, windowSize = 1) {
            // Centered moving average for smoother lines
            // Each point is the average of windowSize days centered on that point
            if (windowSize <= 1) return data;

            const result = [];
            const halfWindow = Math.floor(windowSize / 2);

            for (let i = 0; i < data.length; i++) {
                let sum = 0;
                let count = 0;

                // Use centered window: from (i - halfWindow) to (i + halfWindow)
                for (let j = i - halfWindow; j <= i + halfWindow; j++) {
                    if (j >= 0 && j < data.length && data[j] !== null && data[j] !== undefined) {
                        sum += data[j];
                        count++;
                    }
                }
                result.push(count > 0 ? sum / count : 0);
            }
            return result;
        }

        function getStats(records, author) {
            const filtered = author ? records.filter(r => r.author === author) : records;
            const total = filtered.length;

            if (total === 0) {
                return { total: 0, avgPerWeek: '0', topContributor: 'N/A', weeks: 0 };
            }

            // Calculate weeks span
            const dates = filtered.map(r => r.closedDate).sort();
            const firstDate = new Date(dates[0]);
            const lastDate = new Date(dates[dates.length - 1]);
            const weekSpan = Math.max(1, Math.ceil((lastDate - firstDate) / (7 * 24 * 60 * 60 * 1000)));

            const avgPerWeek = (total / weekSpan).toFixed(1);

            // Top contributor (only relevant for team view)
            let topContributor = author || 'N/A';
            if (!author) {
                const byAuthor = {};
                for (const r of filtered) {
                    byAuthor[r.author] = (byAuthor[r.author] || 0) + 1;
                }
                const top = Object.entries(byAuthor).sort((a, b) => b[1] - a[1])[0];
                topContributor = top ? top[0] : 'N/A';
            }

            return { total, avgPerWeek, topContributor, weeks: weekSpan };
        }

        function renderDashboard() {
            const filteredRecords = filterByRange(allRecords, ranges[selectedRange].days);
            const data = processData(filteredRecords);
            const stats = getStats(filteredRecords, selectedAuthor);

            const { byDay, byAuthor, byProject, days, authorList } = data;
            const smoothingWindow = smoothingEnabled ? ranges[selectedRange].smoothing : 1;
            const smoothingLabel = ranges[selectedRange].smoothingLabel;

            // Helper to get first name
            const getFirstName = (fullName) => fullName.split(' ')[0];

            // Get the color for the selected author (or team color if none selected)
            const selectedAuthorIndex = selectedAuthor ? authorList.indexOf(selectedAuthor) : -1;
            const selectedColor = selectedAuthor
                ? colors[selectedAuthorIndex % colors.length]
                : teamColor;

            let html = `
                <div class="controls-row" style="align-items: flex-start;">
                    <div class="control-group">
                        <label>Time Range</label>
                        <div class="btn-group">
                            ${Object.entries(ranges).map(([key, val]) => `
                                <button class="btn ${selectedRange === key ? 'active' : ''}" onclick="setRange('${key}')">${val.label}</button>
                            `).join('')}
                        </div>
                    </div>
                    <div class="control-group" style="flex: 1;">
                        <label>Contributor</label>
                        <div class="contributor-chips">
                            <span class="chip ${!selectedAuthor ? 'selected' : ''}"
                                  style="background: ${teamColor};"
                                  onclick="setAuthor('')">Team</span>
                            ${authorList.map((a, idx) => {
                                const color = colors[idx % colors.length];
                                return `<span class="chip ${selectedAuthor === a ? 'selected' : ''}"
                                              style="background: ${color}; --chip-color: ${color};"
                                              onclick="setAuthor('${a.replace(/'/g, "\\'")}')">${getFirstName(a)}</span>`;
                            }).join('')}
                        </div>
                    </div>
                </div>

                <div class="stats-row" style="--kpi-color: ${selectedColor};">
                    <div class="stat-card">
                        <h3>PRs Completed</h3>
                        <div class="value">${stats.total}</div>
                        <div class="subtitle">${selectedAuthor || 'Team Total'}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Avg PRs / Week</h3>
                        <div class="value">${stats.avgPerWeek}</div>
                        <div class="subtitle">${selectedAuthor || 'Team Average'}</div>
                    </div>
                    <div class="stat-card">
                        <h3>${selectedAuthor ? 'Contributor' : 'Top Contributor'}</h3>
                        <div class="value">${stats.topContributor}</div>
                        <div class="subtitle">${selectedAuthor ? 'Selected' : 'Most PRs'}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Time Period</h3>
                        <div class="value">${stats.weeks}</div>
                        <div class="subtitle">weeks</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h2>PR Velocity Over Time</h2>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span class="chart-note">${smoothingEnabled && smoothingWindow > 1 ? smoothingLabel + ' applied' : 'showing raw daily data'}</span>
                            <button class="btn ${smoothingEnabled ? 'active' : ''}" onclick="toggleSmoothing()" style="font-size: 12px; padding: 5px 12px;">
                                ${smoothingEnabled ? 'Smoothing On' : 'Smoothing Off'}
                            </button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="velocityChart"></canvas>
                    </div>
                </div>

                <div class="leaderboard">
                    <div class="leaderboard-card">
                        <h3>PRs by Contributor</h3>
                        <div class="leaderboard-item ${!selectedAuthor ? 'selected' : ''}" onclick="setAuthor('')">
                            <span class="name">All Team</span>
                            <span class="count">${data.totalPRs}</span>
                        </div>
                        ${Object.entries(byAuthor)
                            .sort((a, b) => b[1] - a[1])
                            .map(([name, count]) => `
                                <div class="leaderboard-item ${selectedAuthor === name ? 'selected' : ''}" onclick="setAuthor('${name.replace(/'/g, "\\'")}')">
                                    <span class="name">${name}</span>
                                    <span class="count">${count}</span>
                                </div>
                            `).join('')}
                    </div>
                    <div class="leaderboard-card">
                        <h3>PRs by Project</h3>
                        ${Object.entries(byProject)
                            .sort((a, b) => b[1] - a[1])
                            .map(([name, count]) => `
                                <div class="leaderboard-item">
                                    <span class="name">${name}</span>
                                    <span class="count">${count}</span>
                                </div>
                            `).join('')}
                    </div>
                </div>
            `;

            document.getElementById('content').innerHTML = html;

            // Build datasets for the chart
            const datasets = [];

            if (selectedAuthor) {
                // Show only selected author
                const authorData = days.map(d => byDay[d][selectedAuthor] || 0);
                const smoothedAuthor = calculateMovingAverage(authorData, smoothingWindow);

                datasets.push({
                    label: selectedAuthor,
                    data: smoothedAuthor,
                    borderColor: selectedColor,
                    backgroundColor: 'transparent',
                    borderWidth: 3,
                    tension: 0.4,
                    pointRadius: smoothingWindow === 1 ? 2 : 0,
                    pointHoverRadius: 5
                });
            } else {
                // Show team total + all individual contributors
                const teamData = days.map(d => byDay[d].total || 0);
                const smoothedTeam = calculateMovingAverage(teamData, smoothingWindow);

                datasets.push({
                    label: 'Team Total',
                    data: smoothedTeam,
                    borderColor: teamColor,
                    backgroundColor: 'transparent',
                    borderWidth: 3,
                    tension: 0.4,
                    pointRadius: smoothingWindow === 1 ? 2 : 0,
                    pointHoverRadius: 5
                });

                // Add each author as a separate line
                authorList.forEach((author, idx) => {
                    const authorData = days.map(d => byDay[d][author] || 0);
                    const smoothedAuthor = calculateMovingAverage(authorData, smoothingWindow);

                    datasets.push({
                        label: author,
                        data: smoothedAuthor,
                        borderColor: colors[idx % colors.length],
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: smoothingWindow === 1 ? 1 : 0,
                        pointHoverRadius: 4,
                        hidden: false
                    });
                });
            }

            // Create the chart
            const ctx = document.getElementById('velocityChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)} PRs`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'PRs per Week'
                            }
                        }
                    }
                }
            });
        }

        function setRange(range) {
            selectedRange = range;
            renderDashboard();
        }

        function setAuthor(author) {
            selectedAuthor = author || null;
            renderDashboard();
        }

        function toggleSmoothing() {
            smoothingEnabled = !smoothingEnabled;
            renderDashboard();
        }

        function loadData(text) {
            try {
                allRecords = parseCSV(text);
                if (allRecords.length === 0) {
                    document.getElementById('content').innerHTML = '<div class="error">No data found in CSV file</div>';
                    return;
                }
                renderDashboard();
            } catch (err) {
                document.getElementById('content').innerHTML = `<div class="error">Error parsing CSV: ${err.message}</div>`;
            }
        }

        // File input handler
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    loadData(e.target.result);
                };
                reader.readAsText(file);
            }
        });

        // Try to auto-load pr-velocity.csv
        fetch('pr-velocity.csv')
            .then(response => {
                if (!response.ok) throw new Error('File not found');
                return response.text();
            })
            .then(text => loadData(text))
            .catch(err => {
                document.getElementById('content').innerHTML = '';
            });
    </script>
</body>
</html>
